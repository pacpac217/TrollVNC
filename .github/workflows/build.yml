name: Build TrollVNC

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          # Install Homebrew if not already installed
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          # Install required packages
          brew install perl dpkg ldid
      
      - name: Setup Theos
        run: |
          # Clone Theos with submodules (dm.pl might be in a submodule)
          git clone --depth=1 --recursive https://github.com/theos/theos.git $HOME/theos
          export THEOS=$HOME/theos
          echo "THEOS=$THEOS" >> $GITHUB_ENV
          
          # Also create symlink for theos-roothide (bootstrap.sh looks for it)
          ln -sf $HOME/theos $HOME/theos-roothide
          
          # Wait a moment for files to be fully written
          sleep 2
          
          # List Theos directory structure for debugging
          echo "Theos directory structure:"
          ls -la $THEOS/ | head -20
          echo ""
          echo "Checking bin/ directory:"
          ls -la $THEOS/bin/ 2>/dev/null || echo "bin/ directory does not exist"
          echo ""
          echo "Checking vendor/ directory:"
          ls -la $THEOS/vendor/ 2>/dev/null | head -10 || echo "vendor/ directory does not exist"
          
          # Find dm.pl in multiple possible locations
          DM_PL_PATH=""
          
          # Check common locations
          for path in "$THEOS/bin/dm.pl" "$THEOS/vendor/dm.pl/dm.pl" "$THEOS/vendor/dm.pl" "$THEOS/toolchain/linux/iphone/bin/dm.pl"; do
            if [ -e "$path" ]; then
              DM_PL_PATH="$path"
              echo "✓ Found dm.pl at $DM_PL_PATH"
              break
            fi
          done
          
          # If not found, search recursively
          if [ -z "$DM_PL_PATH" ]; then
            echo "⚠ Searching for dm.pl recursively..."
            DM_PL_PATH=$(find $THEOS -name "dm.pl" -type f 2>/dev/null | head -1)
            if [ -n "$DM_PL_PATH" ]; then
              echo "✓ Found dm.pl at $DM_PL_PATH"
            fi
          fi
          
          # If still not found, try to install dm.pl from Theos SDK
          if [ -z "$DM_PL_PATH" ]; then
            echo "⚠ dm.pl not found, checking if we need to install Theos SDK..."
            # Try to run Theos setup script if it exists
            if [ -f "$THEOS/bin/update-theos" ]; then
              echo "Running Theos update script..."
              "$THEOS/bin/update-theos" || true
              sleep 2
              # Check again after update
              DM_PL_PATH=$(find $THEOS -name "dm.pl" -type f 2>/dev/null | head -1)
            fi
          fi
          
          # Final check - if still not found, create a minimal dm.pl wrapper
          if [ -z "$DM_PL_PATH" ]; then
            echo "⚠ WARNING: dm.pl not found in Theos!"
            echo "Creating minimal dm.pl wrapper..."
            mkdir -p "$THEOS/bin"
            # Create dm.pl using echo with append to avoid YAML issues
            echo '#!/usr/bin/env perl' > "$THEOS/bin/dm.pl"
            echo 'use strict;' >> "$THEOS/bin/dm.pl"
            echo 'use warnings;' >> "$THEOS/bin/dm.pl"
            echo 'if ($ARGV[0] eq "--version") { print "dm.pl wrapper 1.0\n"; exit 0; }' >> "$THEOS/bin/dm.pl"
            echo 'exec("dpkg-deb", @ARGV) or die "Cannot execute dpkg-deb: $!";' >> "$THEOS/bin/dm.pl"
            chmod +x "$THEOS/bin/dm.pl"
            DM_PL_PATH="$THEOS/bin/dm.pl"
            echo "✓ Created minimal dm.pl wrapper at $DM_PL_PATH"
          else
            # Make dm.pl executable
            chmod +x "$DM_PL_PATH"
            echo "✓ Made $DM_PL_PATH executable"
            
            # If dm.pl is not in bin/, create symlink in bin/
            if [ "$DM_PL_PATH" != "$THEOS/bin/dm.pl" ]; then
              mkdir -p "$THEOS/bin"
              ln -sf "$DM_PL_PATH" "$THEOS/bin/dm.pl"
              echo "✓ Created symlink: $THEOS/bin/dm.pl -> $DM_PL_PATH"
            fi
          fi
          
          # Create symlink in /usr/local/bin so Xcode's make can find it
          sudo mkdir -p /usr/local/bin
          sudo rm -f /usr/local/bin/dm.pl
          sudo ln -sf "$THEOS/bin/dm.pl" /usr/local/bin/dm.pl
          echo "✓ Created symlink: /usr/local/bin/dm.pl -> $THEOS/bin/dm.pl"
          
          # Verify final setup
          if [ -e "$THEOS/bin/dm.pl" ] && [ -x "$THEOS/bin/dm.pl" ]; then
            echo "✓ Setup complete: dm.pl is ready at $THEOS/bin/dm.pl"
            "$THEOS/bin/dm.pl" --version 2>/dev/null || echo "⚠ dm.pl version check failed, but file exists"
          else
            echo "✗ ERROR: dm.pl setup failed!"
            exit 1
          fi
      
      - name: Build with THEBOOTSTRAP=1 (Standalone App)
        env:
          THEOS: ${{ env.THEOS }}
          THEOS_PACKAGE_SCHEME: rootless
          THEOS_DEVICE_IP: 127.0.0.1
          THEOS_DEVICE_PORT: 58422
          THEOS_DEVICE_SIMULATOR: ""
          THEBOOTSTRAP: 1
          FINALPACKAGE: 1
        run: |
          # Set THEOS from environment
          export THEOS=${{ env.THEOS }}
          
          # Verify dm.pl exists (use -e to check both files and symlinks)
          if [ ! -e "$THEOS/bin/dm.pl" ]; then
            echo "✗ ERROR: $THEOS/bin/dm.pl not found!"
            echo "Searching for dm.pl..."
            find $THEOS -name "dm.pl" 2>/dev/null || echo "dm.pl not found anywhere"
            exit 1
          fi
          
          # Ensure dm.pl is executable
          chmod +x "$THEOS/bin/dm.pl"
          echo "✓ Verified dm.pl is executable at $THEOS/bin/dm.pl"
          
          # Verify symlink in /usr/local/bin exists
          if [ ! -e /usr/local/bin/dm.pl ]; then
            echo "⚠ Warning: /usr/local/bin/dm.pl not found, recreating..."
            sudo mkdir -p /usr/local/bin
            sudo ln -sf "$THEOS/bin/dm.pl" /usr/local/bin/dm.pl
          fi
          
          # Add Theos bin and /usr/local/bin to PATH so dm.pl can be found
          export PATH="$THEOS/bin:/usr/local/bin:$PATH"
          
          # Verify dm.pl is accessible
          echo "Verifying dm.pl accessibility..."
          if [ -x "$THEOS/bin/dm.pl" ]; then
            echo "✓ dm.pl is executable at $THEOS/bin/dm.pl"
          else
            echo "✗ ERROR: dm.pl is not executable!"
            exit 1
          fi
          
          if which dm.pl >/dev/null 2>&1; then
            echo "✓ dm.pl found in PATH: $(which dm.pl)"
          else
            echo "⚠ dm.pl not in PATH, but will use direct path: $THEOS/bin/dm.pl"
          fi
          
          # Test dm.pl directly using full path (most reliable)
          if "$THEOS/bin/dm.pl" --version >/dev/null 2>&1; then
            echo "✓ dm.pl works via direct path!"
          else
            echo "⚠ dm.pl test failed, but continuing with build..."
          fi
          
          echo "=========================================="
          echo "Building with THEBOOTSTRAP=1"
          echo "THEOS=$THEOS"
          echo "SCHEME=rootless"
          echo "VERSION=2.16"
          echo "PATH=$PATH"
          echo "=========================================="
          
          # Build with explicit PATH and ensure THEOS/bin is first
          make clean package THEBOOTSTRAP=1
      
      - name: Create release artifacts
        run: |
          mkdir -p release-artifacts
          echo "Checking for build artifacts..."
          ls -la packages/ || echo "packages directory not found"
          # Copy .deb file
          if [ -f packages/*.deb ]; then
            echo "Found .deb file"
            cp packages/*.deb release-artifacts/
          else
            echo "No .deb file found"
          fi
          # Copy .tipa file (created by after-package.sh when THEBOOTSTRAP=1)
          if [ -f packages/*.tipa ]; then
            echo "Found .tipa file"
            cp packages/*.tipa release-artifacts/
          else
            echo "No .tipa file found - checking if THEBOOTSTRAP was set correctly"
            echo "THEBOOTSTRAP was: $THEBOOTSTRAP"
          fi
          echo "Artifacts in release-artifacts:"
          ls -la release-artifacts/ || echo "No artifacts found"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TrollVNC-build
          path: release-artifacts/*
          retention-days: 30
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: release-artifacts/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
