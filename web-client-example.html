<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrollVNC Web Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: #2d2d2d;
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }
        
        .status-indicator.connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }
        
        .status-indicator.disconnected {
            background: #f44336;
        }
        
        .device-selector {
            background: #2d2d2d;
            padding: 10px 20px;
            border-bottom: 1px solid #444;
        }
        
        .device-selector select {
            width: 100%;
            padding: 8px;
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .vnc-container {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }
        
        #vnc-canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #4caf50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“± TrollVNC Viewer</h1>
            <div class="status">
                <div class="status-indicator disconnected" id="statusIndicator"></div>
                <span id="statusText">Disconnected</span>
            </div>
        </div>
        
        <div class="device-selector">
            <select id="deviceSelect">
                <option value="">-- Select Device --</option>
            </select>
        </div>
        
        <div class="vnc-container">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Connecting to device...</p>
            </div>
            <canvas id="vnc-canvas" style="display: none;"></canvas>
            <div class="error" id="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Configuration - Thay Ä‘á»•i theo server cá»§a báº¡n
        const API_BASE = 'http://serverapi.xyz:3000';
        const WS_BASE = 'ws://serverapi.xyz:8080';
        
        let ws = null;
        let currentDeviceId = null;
        let canvas = null;
        let ctx = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('vnc-canvas');
            ctx = canvas.getContext('2d');
            
            loadDevices();
            setInterval(loadDevices, 5000); // Refresh device list every 5s
            
            document.getElementById('deviceSelect').addEventListener('change', (e) => {
                const deviceId = e.target.value;
                if (deviceId) {
                    connectToDevice(deviceId);
                } else {
                    disconnect();
                }
            });
        });
        
        // Load available devices
        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/api/devices`);
                const data = await response.json();
                
                const select = document.getElementById('deviceSelect');
                const currentValue = select.value;
                
                // Clear and repopulate
                select.innerHTML = '<option value="">-- Select Device --</option>';
                
                data.devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = `${device.deviceId} (${device.clientCount} clients)`;
                    select.appendChild(option);
                });
                
                // Restore selection if still available
                if (currentValue && data.devices.find(d => d.deviceId === currentValue)) {
                    select.value = currentValue;
                }
            } catch (error) {
                console.error('Failed to load devices:', error);
            }
        }
        
        // Connect to device via WebSocket
        function connectToDevice(deviceId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            currentDeviceId = deviceId;
            updateStatus('Connecting...', false);
            document.getElementById('loading').style.display = 'block';
            document.getElementById('vnc-canvas').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            // Connect to WebSocket proxy
            ws = new WebSocket(`${WS_BASE}?deviceId=${deviceId}`);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                updateStatus('Connected', true);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('vnc-canvas').style.display = 'block';
            };
            
            ws.onmessage = (event) => {
                // Handle VNC protocol data
                // Note: This is simplified - you'll need a VNC client library
                // like noVNC for full implementation
                handleVNCData(event.data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('Connection Error', false);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Failed to connect to device';
            };
            
            ws.onclose = () => {
                console.log('WebSocket closed');
                updateStatus('Disconnected', false);
                if (currentDeviceId) {
                    // Try to reconnect after 3 seconds
                    setTimeout(() => {
                        if (currentDeviceId) {
                            connectToDevice(currentDeviceId);
                        }
                    }, 3000);
                }
            };
        }
        
        // Handle VNC protocol data
        function handleVNCData(data) {
            // This is a placeholder - you need to implement VNC protocol parsing
            // Consider using noVNC library: https://github.com/novnc/noVNC
            console.log('Received VNC data:', data.byteLength, 'bytes');
        }
        
        // Send input to device
        function sendInput(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(data);
            }
        }
        
        // Update status indicator
        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            const indicator = document.getElementById('statusIndicator');
            indicator.className = 'status-indicator ' + (connected ? 'connected' : 'disconnected');
        }
        
        // Disconnect
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            currentDeviceId = null;
            updateStatus('Disconnected', false);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('vnc-canvas').style.display = 'none';
        }
        
        // Handle canvas mouse/touch events
        canvas.addEventListener('mousedown', (e) => {
            // Send mouse down event
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            // Convert to VNC coordinates and send
        });
        
        canvas.addEventListener('mousemove', (e) => {
            // Send mouse move event
        });
        
        canvas.addEventListener('mouseup', (e) => {
            // Send mouse up event
        });
    </script>
</body>
</html>

